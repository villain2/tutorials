!function(Box2DTest,undefined){Box2DTest.Version="1.0.0",Box2DTest.Controllers={},Box2DTest.Directives={},Box2DTest.init=function(){function handleMouseMove(e){mouseX=(e.clientX-canvasPosition.x)/30,mouseY=(e.clientY-canvasPosition.y)/30}function getBodyAtMouse(){mousePVec=new b2Vec2(mouseX,mouseY);var aabb=new b2AABB;return aabb.lowerBound.Set(mouseX-.001,mouseY-.001),aabb.upperBound.Set(mouseY-.001,mouseY-.001),selectedBody=null,world.QueryAABB(getBodyCB,aabb),selectedBody}function getBodyCB(fixture){return fixture.GetBody().GetType()!=b2Body.b2_staticBody&&fixture.GetShape().TestPoint(fixture.GetBody().GetTransform(),mousePVec)?(selectedBody=fixture.GetBody(),!1):!0}function update(){if(isMouseDown&&!mouseJoint){var body=getBodyAtMouse();if(body){var md=new b2MouseJointDef;md.bodyA=world.GetGroundBody(),md.bodyB=body,md.target.Set(mouseX,mouseY),md.collideConnected=!0,md.maxForce=300*body.GetMass(),mouseJoint=world.CreateJoint(md),body.SetAwake(!0)}}mouseJoint&&(isMouseDown?mouseJoint.SetTarget(new b2Vec2(mouseX,mouseY)):(world.DestroyJoint(mouseJoint),mouseJoint=null)),world.Step(1/60,10,10),world.DrawDebugData(),world.ClearForces()}function getElementPosition(element){for(var elem=element,tagname="",x=0,y=0;"object"==typeof elem&&"undefined"!=typeof elem.tagName;)return y+=elem.offsetTop,x+=elem.offsetLeft,tagname=elem.tagName.toUpperCase(),"BODY"==tagname&&(elem=0),"object"==typeof elem&&"object"==typeof elem.offsetParent&&(elem=elem.offsetParent),console.log("x: "+x+" / y: "+y),{x:x,y:y}}var b2Vec2=Box2D.Common.Math.b2Vec2,b2AABB=Box2D.Collision.b2AABB,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2World=(Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2World),b2PolygonShape=(Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef,world=new b2World(new b2Vec2(0,10),!0),fixDef=new b2FixtureDef;fixDef.density=1,fixDef.friction=.5,fixDef.restitution=.2;var bodyDef=new b2BodyDef;bodyDef.type=b2Body.b2_staticBody,fixDef.shape=new b2PolygonShape,fixDef.shape.SetAsBox(20,2),bodyDef.position.Set(10,400/30+1.8),world.CreateBody(bodyDef).CreateFixture(fixDef),bodyDef.position.Set(10,-1.8),world.CreateBody(bodyDef).CreateFixture(fixDef),fixDef.shape.SetAsBox(2,14),bodyDef.position.Set(-1.8,13),world.CreateBody(bodyDef).CreateFixture(fixDef),bodyDef.position.Set(21.8,13),world.CreateBody(bodyDef).CreateFixture(fixDef),bodyDef.type=b2Body.b2_dynamicBody;for(var i=0;10>i;i++)Math.random()>.5?(fixDef.shape=new b2PolygonShape,fixDef.shape.SetAsBox(Math.random()+.1,Math.random()+.1)):fixDef.shape=new b2CircleShape(Math.random()+.1),bodyDef.position.x=10*Math.random(),bodyDef.position.y=10*Math.random(),world.CreateBody(bodyDef).CreateFixture(fixDef);var debugDraw=new b2DebugDraw;debugDraw.SetSprite(document.getElementById("displayArea").getContext("2d")),debugDraw.SetDrawScale(30),debugDraw.SetFillAlpha(.5),debugDraw.SetLineThickness(1),debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),world.SetDebugDraw(debugDraw),window.setInterval(update,1e3/60);var mouseX,mouseY,mousePVec,isMouseDown,selectedBody,mouseJoint,canvasPosition=getElementPosition(document.getElementById("displayArea"));console.log(canvasPosition),document.addEventListener("mousedown",function(e){isMouseDown=!0,handleMouseMove(e),document.addEventListener("mousemove",handleMouseMove,!0)},!0),document.addEventListener("mouseup",function(){document.removeEventListener("mousemove",handleMouseMove,!0),isMouseDown=!1,mouseX=undefined,mouseY=undefined},!0)}}(window.Box2DTest=window.Box2DTest||{}),$(document).ready(function(){Box2DTest.init()});